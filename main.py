"""
–ü—Ä–æ—Å—Ç–æ–π –∞–≥–µ–Ω—Ç –Ω–∞ CrewAI –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ AI Agents –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±–ª–æ–≥-–ø–æ—Å—Ç–∞.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI API –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ LLM.
"""
import os
import requests
from dotenv import load_dotenv
from crewai import Agent, Task, Crew, Process
from crewai.tools import tool
from langchain_openai import ChatOpenAI

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv(override=True)

# –°–æ–∑–¥–∞–µ–º LLM –¥–ª—è OpenAI
# ChatOpenAI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞–µ—Ç OPENAI_API_KEY –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# –í–ê–ñ–ù–û: –í —Ñ–∞–π–ª–µ .env –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è OPENAI_API_KEY=–≤–∞—à_–∫–ª—é—á
openai_llm = ChatOpenAI(
    model='gpt-4o-mini',  # –ò—Å–ø–æ–ª—å–∑—É–µ–º gpt-4o-mini - –±—ã—Å—Ç—Ä—É—é –∏ –Ω–µ–¥–æ—Ä–æ–≥—É—é –º–æ–¥–µ–ª—å OpenAI
    temperature=0.7
)

# –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ Serper API
@tool("–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ")
def serper_search(query: str) -> str:
    """–ü–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ —á–µ—Ä–µ–∑ Serper API. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ AI Agents."""
    api_key = os.getenv('SERPER_API_KEY')
    if not api_key:
        return "–û—à–∏–±–∫–∞: API –∫–ª—é—á Serper –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env"
    
    url = "https://google.serper.dev/search"
    headers = {
        'X-API-KEY': api_key,
        'Content-Type': 'application/json'
    }
    payload = {
        'q': query,
        'num': 10
    }
    
    try:
        response = requests.post(url, headers=headers, json=payload)
        response.raise_for_status()
        data = response.json()
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        results = []
        if 'organic' in data:
            for item in data['organic'][:5]:  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                title = item.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
                link = item.get('link', '')
                snippet = item.get('snippet', '')
                results.append(f"–ù–∞–∑–≤–∞–Ω–∏–µ: {title}\n–°—Å—ã–ª–∫–∞: {link}\n–û–ø–∏—Å–∞–Ω–∏–µ: {snippet}\n")
        
        return "\n".join(results) if results else "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {str(e)}"

# –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è
researcher = Agent(
    role='–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å AI –Ω–æ–≤–æ—Å—Ç–µ–π',
    goal='–ù–∞–π—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ AI Agents –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ',
    backstory='''–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö 
    –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –¢—ã —É–º–µ–µ—à—å –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∏ –≤–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ 
    –≤ –æ–±–ª–∞—Å—Ç–∏ AI Agents, –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.''',
    verbose=True,
    allow_delegation=False,
    tools=[serper_search],
    llm=openai_llm
)

# –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞-–ø–∏—Å–∞—Ç–µ–ª—è
writer = Agent(
    role='–ë–ª–æ–≥-–ø–∏—Å–∞—Ç–µ–ª—å',
    goal='–ù–∞–ø–∏—Å–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è –±–ª–æ–≥–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π',
    backstory='''–¢—ã —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –±–ª–æ–≥-–ø–∏—Å–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 
    –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å—Ç–∞—Ç–µ–π –ø—Ä–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç. –¢—ã —É–º–µ–µ—à—å 
    —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –¥–µ–ª–∞—Ç—å –µ–µ –ø–æ–Ω—è—Ç–Ω–æ–π –¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏ 
    –ø–∏—Å–∞—Ç—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.''',
    verbose=True,
    allow_delegation=False,
    llm=openai_llm
)

# –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
research_task = Task(
    description='''–ù–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1-2 –Ω–µ–¥–µ–ª–∏) 
    –ø—Ä–æ AI Agents. –°–æ–±–µ—Ä–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ 3-5 —Å–∞–º—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∏ –≤–∞–∂–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö. 
    –í–∫–ª—é—á–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
    - –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
    - –ò—Å—Ç–æ—á–Ω–∏–∫ –∏ –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
    - –ü–æ—á–µ–º—É —ç—Ç–∞ –Ω–æ–≤–æ—Å—Ç—å –≤–∞–∂–Ω–∞''',
    agent=researcher,
    expected_output='–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ 3-5 –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ AI Agents —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏, –¥–∞—Ç–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏'
)

# –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å—Ç–∞
writing_task = Task(
    description='''–ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ AI Agents, —á—Ç–æ–±—ã 
    –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–≥-–ø–æ—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
    - –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º
    - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º (—Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–±–∑–∞—Ü–∞–º–∏)
    - –ù–∞–ø–∏—Å–∞–Ω–Ω—ã–º –¥–ª—è —à–∏—Ä–æ–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    - –û–±—ä–µ–º–æ–º –ø—Ä–∏–º–µ—Ä–Ω–æ 300-500 —Å–ª–æ–≤
    - –í–∫–ª—é—á–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
    - –û—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é —Å–æ–±—Ä–∞–ª –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å''',
    agent=writer,
    context=[research_task],  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    expected_output='–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –±–ª–æ–≥-–ø–æ—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –æ–±—ä–µ–º–æ–º 300-500 —Å–ª–æ–≤ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º'
)

# –°–æ–∑–¥–∞–µ–º crew (–∫–æ–º–∞–Ω–¥—É)
crew = Crew(
    agents=[researcher, writer],
    tasks=[research_task, writing_task],
    process=Process.sequential,  # –ó–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
    verbose=True
)

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI –≤ –∫–∞—á–µ—Å—Ç–≤–µ LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞."""
    print("üöÄ –ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ CrewAI –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –±–ª–æ–≥-–ø–æ—Å—Ç–∞...")
    print("üì° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OpenAI API –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ LLM")
    print("=" * 70)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö API –∫–ª—é—á–µ–π
    missing_keys = []
    openai_key = os.getenv('OPENAI_API_KEY')
    serper_key = os.getenv('SERPER_API_KEY')
    
    if not openai_key:
        missing_keys.append('OPENAI_API_KEY')
    else:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ OpenAI
        if not openai_key.startswith('sk-'):
            print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: API –∫–ª—é—á OpenAI –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'sk-'")
            print(f"   –¢–µ–∫—É—â–∏–π –∫–ª—é—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: {openai_key[:10] if len(openai_key) >= 10 else openai_key}...")
            print("   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –æ—Ç OpenAI")
            print("   –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –º–æ–∂–Ω–æ –∑–¥–µ—Å—å: https://platform.openai.com/api-keys")
    
    if not serper_key:
        missing_keys.append('SERPER_API_KEY')
    
    if missing_keys:
        print(f"‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ API –∫–ª—é—á–∏: {', '.join(missing_keys)}")
        print("   –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–º —É–∫–∞–∑–∞–Ω—ã:")
        if 'OPENAI_API_KEY' in missing_keys:
            print("   OPENAI_API_KEY=–≤–∞—à_–∫–ª—é—á_openai")
            print("   (–î–ª—è OpenAI –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å sk-)")
        if 'SERPER_API_KEY' in missing_keys:
            print("   SERPER_API_KEY=–≤–∞—à_–∫–ª—é—á_serper")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª—é—á –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–æ–º
    if openai_key and ('your' in openai_key.lower() or 'example' in openai_key.lower()):
        print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ö–æ–∂–µ, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–ª—é—á–∞ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ!")
        print("   –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–º–µ–Ω–∏—Ç–µ –∫–ª—é—á –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –æ—Ç OpenAI")
        return
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º crew
    result = crew.kickoff()
    
    print("\n" + "=" * 70)
    print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞:")
    print("=" * 70)
    print(result)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª
    with open('blog_post.txt', 'w', encoding='utf-8') as f:
        f.write(str(result))
    print("\nüìù –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª blog_post.txt")

if __name__ == '__main__':
    main()
